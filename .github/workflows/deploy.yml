name: Deploy

# Deploy runs only on push to main. It uses path filters to deploy frontend (Vercel)
# and backend (Render or placeholder) only when the relevant paths changed.
on:
  push:
    branches: [main]

jobs:
  filter:
    name: Determine changed areas
    runs-on: ubuntu-latest
    outputs:
      web_changed: ${{ steps.filter.outputs.web }}
      backend_changed: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: dorny/paths-filter
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            web:
              - 'web/**'
            backend:
              - 'services/**'
              - 'libs/**'

  deploy-web:
    name: Deploy Web to Vercel
    needs: filter
    if: needs.filter.outputs.web_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        # Requires repository secrets: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: web

  deploy-backend:
    name: Deploy Backend (Render placeholder)
    needs: filter
    if: needs.filter.outputs.backend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy (placeholder)
        if: ${{ secrets.RENDER_API_KEY != '' }}
        run: |
          echo "Triggering Render deploy for changed services..."
          # Example: curl -X POST -H 'Authorization: Bearer $RENDER_API_KEY' \
          #   -H 'Content-Type: application/json' \
          #   -d '{"serviceId":"'$RENDER_SERVICE_ID'"}' \
          #   https://api.render.com/deploys
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}

      - name: No Render secrets configured
        if: ${{ secrets.RENDER_API_KEY == '' }}
        run: |
          echo "No Render deployment configured. Set RENDER_API_KEY/RENDER_SERVICE_ID in repository secrets to enable."
