# Manual helper workflow to dispatch the existing CI workflows (ci-web.yml, ci-backend.yml)
# Use Actions UI -> Run workflow to trigger both CI workflows on a given ref.
name: Trigger CI runs (manual)

# Grant token permission to create workflow dispatch events
permissions:
  contents: read
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to run the CI workflows on'
        required: false
        default: 'main'

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch CI workflows
        uses: actions/github-script@v6
        env:
          DISPATCH_PAT: ${{ secrets.DISPATCH_PAT }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.payload?.inputs?.ref || (context.ref ? context.ref.replace('refs/heads/', '') : 'main');
            const workflows = ['ci-web.yml', 'ci-backend.yml'];
            const token = process.env.DISPATCH_PAT || process.env.GITHUB_TOKEN;
            const { Octokit } = require('@octokit/rest');
            const oct = new Octokit({ auth: token });
            for (const wf of workflows) {
              core.info(`Dispatching workflow ${wf} on ref ${ref}`);
              try {
                await oct.actions.createWorkflowDispatch({ owner, repo, workflow_id: wf, ref });
                core.info(`Dispatched ${wf}`);
              } catch (err) {
                core.warning(`Failed to dispatch ${wf}: ${err.message}`);
                core.notice(`If you see 'Resource not accessible by integration', set a personal access token in secrets and use it instead.`);
              }
            }
