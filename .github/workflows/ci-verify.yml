name: CI - Verify

on:
  pull_request:
  push:
    branches: [main]

jobs:
  determine-changes:
    name: Determine changed areas
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.filter.outputs.web }}
      backend-changed: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine changed paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            web: 'web/**'
            backend: 'services/**|libs/**'

  verify:
    name: Verify CI status for changed areas
    runs-on: ubuntu-latest
    needs: determine-changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify CI workflow runs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.DISPATCH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.pull_request ? context.payload.pull_request.head.sha : process.env.GITHUB_SHA;
            const filterWeb = '${{ needs.determine-changes.outputs.web-changed }}' === 'true';
            const filterBackend = '${{ needs.determine-changes.outputs.backend-changed }}' === 'true';

            core.info(`Checking CI status for commit ${sha}. web_changed=${filterWeb} backend_changed=${filterBackend}`);
            // Determine ref to dispatch workflows on (branch name)
            const ref = context.payload.pull_request ? context.payload.pull_request.head.ref : (context.ref || '').replace('refs/heads/', '');

            // Dispatch CI workflows for the changed areas so they run under this commit/branch.
            if (filterWeb) {
              core.info(`Dispatching frontend workflow on ref=${ref}`);
              try {
                await github.rest.actions.createWorkflowDispatch({ owner, repo, workflow_id: 'frontend-ci.yml', ref });
              } catch (err) {
                core.warning(`Failed to dispatch frontend workflow: ${String(err)}`);
              }
            }
            if (filterBackend) {
              core.info(`Dispatching backend workflow on ref=${ref}`);
              try {
                await github.rest.actions.createWorkflowDispatch({ owner, repo, workflow_id: 'backend-ci.yml', ref });
              } catch (err) {
                core.warning(`Failed to dispatch backend workflow: ${String(err)}`);
              }
            }

            // Small pause to allow dispatched workflow run to appear in listWorkflowRuns
            if (filterWeb || filterBackend) await new Promise(r => setTimeout(r, 3000));

            async function findRunForWorkflow(workflowIdentifiers) {
              for (const id of workflowIdentifiers) {
                try {
                  const runs = await github.rest.actions.listWorkflowRuns({ owner, repo, workflow_id: id, per_page: 100 });
                  const run = runs.data.workflow_runs.find(r => r.head_sha === sha);
                  if (run) return run;
                } catch (err) {
                  if (err.status === 404) {
                    core.warning(`Workflow identifier '${id}' not found; skipping.`);
                    continue;
                  }
                  throw err;
                }
              }
              return null;
            }

            async function waitForWorkflowSuccess(identifiers) {
              const run = await findRunForWorkflow(identifiers);
              if (!run) {
                core.error(`No workflow run found for identifiers: ${identifiers.join(', ')} on commit ${sha}`);
                return false;
              }
              core.info(`Found workflow run id=${run.id} name=${run.name} status=${run.status} conclusion=${run.conclusion}`);
              if (run.status === 'completed') return run.conclusion === 'success';
              for (let i = 0; i < 30; i++) {
                const r = await github.rest.actions.getWorkflowRun({ owner, repo, run_id: run.id });
                if (r.data.status === 'completed') return r.data.conclusion === 'success';
                await new Promise(r => setTimeout(r, 5000));
              }
              core.warning('Timed out waiting for workflow run to complete');
              return false;
            }

            let ok = true;
            if (filterWeb) ok = ok && await waitForWorkflowSuccess(['ci-web.yml','CI - Web']);
            if (filterBackend) ok = ok && await waitForWorkflowSuccess(['ci-backend.yml','CI - Backend']);

            if (!ok) core.setFailed('Required CI workflow(s) did not succeed for this commit.');
